From 6adffab3a22a2aa1fa63dad19897106ff03a27dd Mon Sep 17 00:00:00 2001
From: Euphyllia Bierque <bierque.euphyllia@gmail.com>
Date: Thu, 4 Sep 2025 00:03:44 +0200
Subject: [PATCH 08/20] Patch Insights API src main java dev frankheijden in

---
 .../config/notifications/BossBarNotification.java  | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/Insights-API/src/main/java/dev/frankheijden/insights/api/config/notifications/BossBarNotification.java b/Insights-API/src/main/java/dev/frankheijden/insights/api/config/notifications/BossBarNotification.java
index 0ad5823..74450a3 100644
--- a/Insights-API/src/main/java/dev/frankheijden/insights/api/config/notifications/BossBarNotification.java
+++ b/Insights-API/src/main/java/dev/frankheijden/insights/api/config/notifications/BossBarNotification.java
@@ -20,7 +20,7 @@ public class BossBarNotification implements Notification {
     protected final Queue<Audience> viewers = new LinkedList<>();
     protected final int ticks;
     protected final Runnable bossBarClearer;
-    protected BukkitTask task;
+    protected io.papermc.paper.threadedregions.scheduler.ScheduledTask task;
 
     protected BossBarNotification(InsightsPlugin plugin, BossBar bossBar, Messages.Message content, int ticks) {
         this.plugin = plugin;
@@ -29,7 +29,11 @@ public class BossBarNotification implements Notification {
         this.ticks = ticks;
         this.bossBarClearer = () -> {
             while (!viewers.isEmpty()) {
-                viewers.poll().hideBossBar(bossBar);
+                var audience = viewers.poll();
+                if (audience == null) {
+                    continue;
+                }
+                audience.hideBossBar(bossBar);
             }
         };
     }
@@ -52,10 +56,14 @@ public class BossBarNotification implements Notification {
 
                 while (!receivers.isEmpty()) {
                     var audience = receivers.poll();
+                    if (audience == null) {
+                        continue;
+                    }
                     audience.showBossBar(bossBar);
                     viewers.add(audience);
                 }
-                task = Bukkit.getScheduler().runTaskLater(plugin, bossBarClearer, ticks);
+                task = org.bukkit.Bukkit.getAsyncScheduler()
+                        .runDelayed(plugin, scheduledTask -> bossBarClearer.run(), ticks * 50L, java.util.concurrent.TimeUnit.MILLISECONDS);
             }
         };
     }
-- 
2.50.1.windows.1

